<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Squid Game Elimination</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { margin:0; padding:0; overflow:hidden; }
@keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
@keyframes scaleIn { from{transform:scale(0.5);opacity:0;} to{transform:scale(1);opacity:1;} }
.animate-fadeIn{animation:fadeIn 0.8s ease-out;}
.animate-scaleIn{animation:scaleIn 0.8s ease-out;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const PhotoGrid = () => {
    const ELIM_FLASH_DUR = 500;
    const FADE_OUT_DUR = 700;
    const FLASH_SCALE = 1.1;
    const FADE_SCALE = 0.9;
    const ELIM_OPACITY = 0.4;
    const FLASH_BRIGHT = 1.5;

    const [visible,setVisible] = useState(new Set());
    const [eliminated,setEliminated] = useState(new Set());
    const [flashing,setFlashing] = useState(new Set());
    const [allVisible,setAllVisible] = useState(false);
    const [winner,setWinner] = useState(null);
    const [audioCtx,setAudioCtx] = useState(null);
    const [started,setStarted] = useState(false);
    const [players,setPlayers] = useState([]);
    const [winnerNum,setWinnerNum] = useState(null);
    const [showWinnerCard,setShowWinnerCard] = useState(true);
    const [shuffled,setShuffled] = useState([]);
    const [cols,setCols] = useState(1);

    useEffect(()=>{
        try{
            const ctx = new (window.AudioContext||window.webkitAudioContext)();
            setAudioCtx(ctx);
        }catch(e){}
    },[]);

    const fetchPlayers = async () => {
        const res = await fetch("https://script.google.com/macros/s/AKfycbxIRwkoQFXXWxSCxd8rP3MQvCmnkl1Ha_nAi-n3Zh4DwB_e2pzR2QMblfNhyaADx_4j/exec");
        const data = await res.json();
        setPlayers(data.players);
        setWinnerNum(data.winnerNumber);
    };

    const initGame = () => {
        setStarted(true);
        fetchPlayers();
    };

    const playSound = (freq,dur,type='sine',vol=0.3)=>{
        if(!audioCtx) return;
        const o=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value=freq; o.type=type;
        g.gain.setValueAtTime(vol,audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+dur);
        o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime+dur);
    };

    const playFadeInSound=()=>playSound(1000,0.08,'sine',0.2);
    const playElimSound=()=>playSound(200,0.12,'triangle',0.3);
    const playWinnerSound=()=>{
        playSound(523.25,0.5,'triangle',0.3);
        setTimeout(()=>playSound(659.25,0.5,'triangle',0.3),150);
        setTimeout(()=>playSound(783.99,0.7,'triangle',0.3),300);
        setTimeout(()=>playSound(1046.5,1.0,'triangle',0.4),450);
    };

    useEffect(()=>{
        if(players.length===0) return;
        const pos=[...Array(players.length).keys()];
        for(let i=pos.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [pos[i],pos[j]]=[pos[j],pos[i]];
        }
        const mapped = pos.map((p,i)=>({
            ...players[p],
            id:i,
            isWinner: players[p].number===winnerNum
        }));
        setShuffled(mapped);
    },[players,winnerNum]);

    useEffect(()=>{
        if(shuffled.length===0) return;
        const sw=window.innerWidth; const sh=window.innerHeight;
        const total=shuffled.length;
        let bestCols=1,bestSize=0;
        for(let c=1;c<=total;c++){
            const r=Math.ceil(total/c);
            const cw=sw/c; const ch=sh/r;
            const size=Math.min(cw,ch);
            if(size>bestSize){bestSize=size;bestCols=c;}
        }
        setCols(bestCols);
    },[shuffled]);

    // Fade-in: first 5 slower, rest finish in <2s
    useEffect(()=>{
        if(!started || shuffled.length===0) return;
        const indices=[...Array(shuffled.length).keys()];
        for(let i=indices.length-1;i>0;i--){
            const j=Math.floor(Math.random()*(i+1));
            [indices[i],indices[j]]=[indices[j],indices[i]];
        }
        const totalFast = shuffled.length - 5;
        const fastDuration = 2000; // 2 seconds total for remaining
        const perFast = fastDuration / totalFast;

        indices.forEach((idx,order)=>{
            let delay;
            if(order<5) delay = order*400; // first 5 slow
            else delay = 5*400 + (order-5)*perFast; // rest fast
            setTimeout(()=>{
                setVisible(prev=>new Set([...prev,idx]));
                playFadeInSound();
                if(order===indices.length-1) setTimeout(()=>setAllVisible(true),50);
            },delay);
        });
    },[shuffled,started]);

    // Random elimination
    useEffect(()=>{
        if(!allVisible) return;
        setTimeout(()=>{
            const groupSize=Math.max(1,Math.floor(shuffled.length/5));
            const nonWinners=shuffled.filter(p=>!p.isWinner);
            const winnerPlayer=shuffled.find(p=>p.isWinner);
            let remaining=[...nonWinners];
            const numGroups=Math.ceil(nonWinners.length/groupSize);

            for(let i=0;i<numGroups;i++){
                setTimeout(()=>{
                    const group=[];
                    for(let g=0;g<groupSize && remaining.length>0;g++){
                        const randIdx=Math.floor(Math.random()*remaining.length);
                        group.push(remaining[randIdx].id);
                        remaining.splice(randIdx,1);
                    }
                    setFlashing(prev=>new Set([...prev,...group]));
                    playElimSound();
                    setTimeout(()=>{
                        setEliminated(prev=>{
                            const newSet=new Set(prev);
                            group.forEach(id=>newSet.add(id));
                            return newSet;
                        });
                        setFlashing(prev=>{
                            const newSet=new Set(prev);
                            group.forEach(id=>newSet.delete(id));
                            return newSet;
                        });
                    },ELIM_FLASH_DUR);

                    if(i===numGroups-1){
                        setTimeout(()=>{
                            setWinner(winnerPlayer);
                            setShowWinnerCard(true);
                            playWinnerSound();
                        },ELIM_FLASH_DUR+100);
                    }
                },i*ELIM_FLASH_DUR*2);
            }
        },50);
    },[allVisible,shuffled]);

    if(!started){
        return <div className="w-full h-screen flex items-center justify-center bg-black">
            <button onClick={initGame} className="bg-pink-500 hover:bg-pink-600 text-white text-xl font-bold py-6 px-6 md:px-12 rounded-lg shadow-lg animate-fadeIn text-center">
                Show contestants of 1st Real Life - Squid Game Albania
            </button>
        </div>
    }

    return (
        <div className="w-full h-screen bg-black relative flex flex-col items-center justify-center">
            <div className="mb-2 text-white text-center">
                <p className="text-sm md:text-lg">Visible: {visible.size} | Eliminated: {eliminated.size} | Remaining: {visible.size-eliminated.size}</p>
            </div>
            <div className="grid gap-1 w-full h-full" style={{gridTemplateColumns:`repeat(${cols},1fr)`}}>
                {shuffled.map(player=>{
                    const isVisible=visible.has(player.id);
                    const isEliminated=eliminated.has(player.id);
                    const isFlashing=flashing.has(player.id);
                    const isWinner=player.isWinner && winner;
                    return <div key={player.id} className="relative w-full h-full"
                        style={{
                            opacity:!isVisible?0:isEliminated?ELIM_OPACITY:1,
                            transform:!isVisible?'scale(0.5)':isFlashing?`scale(${FLASH_SCALE})`:isEliminated?`scale(${FADE_SCALE})`:'scale(1)',
                            filter:isFlashing?`brightness(${FLASH_BRIGHT})`:'none',
                            zIndex:isFlashing?10:1,
                            transition:isFlashing?`all ${ELIM_FLASH_DUR}ms ease-out`:`all ${FADE_OUT_DUR}ms ease-out`
                        }}>
                        <img src={isWinner && showWinnerCard ? winner.image : player.image} alt={player.name} className="w-full h-full object-contain"/>
                        <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white text-xs md:text-sm py-1 px-1 text-center font-bold">
                            {player.number}
                        </div>
                        {(isEliminated||isFlashing)&&<div className="absolute inset-0 flex items-center justify-center pointer-events-none bg-black bg-opacity-70">
                            <div className="text-red-600 text-4xl md:text-6xl font-bold drop-shadow-lg" style={{textShadow:'0 0 20px rgba(220,38,38,0.8)'}}>âœ•</div>
                        </div>}
                    </div>
                })}
            </div>

            {winner && showWinnerCard && <div className="fixed inset-0 flex items-center justify-center z-50 animate-fadeIn">
                <div className="absolute inset-0 bg-black bg-opacity-80"/>
                <div className="relative animate-scaleIn">
                    <div className="absolute inset-0 bg-gradient-to-r from-yellow-400 via-yellow-300 to-yellow-400 rounded-lg blur-3xl opacity-75 animate-pulse" style={{transform:'scale(1.5)'}}/>
                    <div className="relative bg-gradient-to-br from-yellow-500 to-yellow-600 p-2 rounded-lg shadow-2xl w-72 md:w-96">
                        <button onClick={()=>setShowWinnerCard(false)} className="absolute top-2 right-2 text-white font-bold text-xl bg-red-600 px-3 py-1 rounded-lg z-50">X</button>
                        <div className="w-full h-72 md:h-80 overflow-hidden rounded-lg border-4 border-yellow-300 flex items-center justify-center">
                            <img src={winner.image} alt={winner.name} className="w-full h-full object-contain"/>
                        </div>
                        <div className="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-yellow-400 to-yellow-500 px-8 py-3 rounded-full shadow-xl border-4 border-yellow-300">
                            <div className="text-xl md:text-2xl font-bold text-white flex items-center gap-2">
                                <span className="text-2xl md:text-3xl">ðŸ‘‘</span>WINNER<span className="text-2xl md:text-3xl">ðŸ‘‘</span>
                            </div>
                        </div>
                        <div className="mt-4 text-center bg-black bg-opacity-30 rounded-lg py-3 px-4">
                            <div className="text-2xl md:text-3xl font-bold text-white mb-1">Player {winner.number}</div>
                        </div>
                    </div>
                </div>
            </div>}
        </div>
    )
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<PhotoGrid />);
</script>
</body>
</html>
